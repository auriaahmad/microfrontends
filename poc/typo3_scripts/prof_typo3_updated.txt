<!-- TYPO3 Profile Page - Secure Version -->
<div class="typo3-profile">
    <!-- Remote Header Container -->
    <div id="typo3-remote-header-container"></div>

    <!-- Profile Content -->
    <div id="typo3-profile-content">
        <div style="text-align: center; padding: 50px;">
            <div style="font-size: 18px; color: #666; margin-bottom: 10px;">
                üîÑ Checking authentication status...
            </div>
        </div>
    </div>
</div>

<style>
.typo3-profile {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    font-family: Arial, sans-serif;
}

.profile-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.unauthorized-content {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 500px;
    margin: 50px auto;
    border: 2px solid #f44336;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #2196F3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<script>
console.log('üü¢ TYPO3 Secure Profile - Starting at', new Date().toLocaleTimeString());

// Clean auth state (NO TOKEN STORAGE)
let authState = {
    isAuthenticated: false,
    user: null,
    isLoading: true
    // ‚úÖ No token field
};

// Check for conflicting instances
if (window.typo3ProfilePage) {
    console.log('üõë Stopping old profile page instance');
    if (window.typo3ProfilePage.destroy) {
        window.typo3ProfilePage.destroy();
    }
    window.typo3ProfilePage = null;
}

// Initialize webpack environment
function setupWebpackEnvironment() {
    window.React = window.React || React;
    window.ReactDOM = window.ReactDOM || ReactDOM;

    window.__webpack_share_scopes__ = window.__webpack_share_scopes__ || {};
    window.__webpack_share_scopes__.default = window.__webpack_share_scopes__.default || {};

    window.__webpack_share_scopes__.default.react = {
        "18.0.0": { get: () => () => window.React, loaded: true }
    };

    window.__webpack_share_scopes__.default["react-dom"] = {
        "18.0.0": { get: () => () => window.ReactDOM, loaded: true }
    };

    window.__webpack_init_sharing__ = window.__webpack_init_sharing__ || (() => Promise.resolve());
}

// Load remote components including AuthProvider
async function loadRemoteComponents() {
    try {
        console.log('üì¶ TYPO3 Profile: Loading remote components...');

        // Load remote entry if not loaded
        if (!window.remoteCounter) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'http://5.175.26.251:3001/remoteEntry.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });

            // Wait for container
            let attempts = 0;
            while (!window.remoteCounter && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
        }

        if (window.remoteCounter) {
            await window.remoteCounter.init(window.__webpack_share_scopes__.default);

            // Load Header
            const headerFactory = await window.remoteCounter.get('./Header');
            const HeaderModule = headerFactory();
            const RemoteHeader = HeaderModule.default;

            // Load AuthProvider - THIS IS KEY!
            const authProviderFactory = await window.remoteCounter.get('./AuthProvider');
            const AuthProvider = authProviderFactory().default;

            // Create invisible AuthProvider to handle messages
            const authContainer = document.createElement('div');
            authContainer.style.display = 'none';
            document.body.appendChild(authContainer);

            const authRoot = ReactDOM.createRoot(authContainer);
            authRoot.render(React.createElement(AuthProvider, {},
                React.createElement('div') // Empty child
            ));

            // Load header with AuthProvider context
            const headerContainer = document.getElementById('typo3-remote-header-container');
            if (headerContainer) {
                const headerRoot = ReactDOM.createRoot(headerContainer);
                headerRoot.render(React.createElement(RemoteHeader, {
                    currentPage: 'profile',
                    onNavigate: (page) => {
                        if (page === 'dashboard') {
                            window.location.href = 'http://typo3.local/typo3-remote/dashboard';
                        }
                    }
                }));
            }

            console.log('‚úÖ TYPO3 Profile: Remote components loaded with AuthProvider');
        }
    } catch (error) {
        console.error('‚ùå TYPO3 Profile: Component loading failed:', error);
    }
}

// Initialize secure auth system
function initializeSecureAuth() {
    console.log('üîí TYPO3 Profile: Initializing secure auth...');

    // Listen for auth status from remote (NO TOKENS)
    window.addEventListener('message', (event) => {
        // Basic origin validation - Allow both localhost and typo3.local
        const allowedOrigins = [
            'http://5.175.26.251:3001',
            'http://typo3.local:3001',
            window.location.origin,
            'http://localhost:3000'  // React host
        ];

        if (!allowedOrigins.includes(event.origin)) {
            console.warn(`‚ö†Ô∏è TYPO3 Profile: Message from unknown origin: ${event.origin}`);
            return;
        }

        if (event.data?.type === 'AUTH_STATUS_UPDATE') {
            const { isAuthenticated, user } = event.data.payload;

            console.log(`üì® TYPO3 Profile: Auth status from ${event.origin} - ${isAuthenticated ? 'authenticated' : 'not authenticated'}`);
            console.log('üî• RECEIVED AUTH_STATUS_UPDATE:', event.data);

            authState = {
                isAuthenticated,
                user,
                isLoading: false
                // ‚úÖ No token storage
            };

            updateProfileUI();
        }
    });

    // Request auth status from remote
    setTimeout(() => {
        console.log('üîç TYPO3 Profile: Requesting auth status...');

        // DEBUG: Test if postMessage works
        console.log('üî• SENDING MESSAGE:', {
            type: 'REQUEST_AUTH_STATUS',
            payload: { timestamp: Date.now() }
        });

        window.postMessage({
            type: 'REQUEST_AUTH_STATUS',
            payload: { timestamp: Date.now() }
        }, '*');

        // DEBUG: Also try parent window
        if (window.parent !== window) {
            console.log('üî• ALSO SENDING TO PARENT');
            window.parent.postMessage({
                type: 'REQUEST_AUTH_STATUS',
                payload: { timestamp: Date.now() }
            }, '*');
        }

        // Fallback timeout
        setTimeout(() => {
            if (authState.isLoading) {
                console.log('‚ö†Ô∏è TYPO3 Profile: Auth check timeout');
                authState.isLoading = false;
                updateProfileUI();
            }
        }, 3000);
    }, 500);
}

// Update profile UI based on auth state
function updateProfileUI() {
    const container = document.getElementById('typo3-profile-content');

    if (authState.isLoading) {
        container.innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <div style="font-size: 18px; color: #666; margin-bottom: 10px;">
                    üîÑ Checking authentication status...
                </div>
                <div class="loading-spinner"></div>
            </div>
        `;
        return;
    }

    if (authState.isAuthenticated && authState.user) {
        renderAuthenticatedProfile();
    } else {
        renderUnauthorizedProfile();
    }
}

// Render authenticated profile
function renderAuthenticatedProfile() {
    console.log('‚úÖ TYPO3 Profile: Rendering authenticated profile');

    const container = document.getElementById('typo3-profile-content');
    container.innerHTML = `
        <div class="profile-section">
            <h2>üë§ User Profile</h2>
            <div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 12px; color: #2e7d32;">
                üîí <strong>Security Notice:</strong> Profile data retrieved securely through remote authentication system.
            </div>
            <div style="margin: 20px 0;">
                <p><strong>Username:</strong> ${authState.user.username}</p>
                <p><strong>Email:</strong> ${authState.user.email}</p>
                <p><strong>Role:</strong>
                    <span style="background: ${authState.user.role === 'admin' ? '#ff5722' : '#2196F3'}; color: white; padding: 4px 12px; border-radius: 16px;">
                        ${authState.user.role}
                    </span>
                </p>
            </div>
            <div style="display: flex; gap: 15px;">
                <button onclick="window.location.href='http://typo3.local/typo3-remote/dashboard'" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    üè† Back to Dashboard
                </button>
            </div>
        </div>
    `;
}

// Render unauthorized profile
function renderUnauthorizedProfile() {
    console.log('üîí TYPO3 Profile: Rendering unauthorized profile');

    const container = document.getElementById('typo3-profile-content');
    container.innerHTML = `
        <div class="unauthorized-content">
            <div style="font-size: 64px; margin-bottom: 20px;">üîê</div>
            <h2 style="color: #f44336;">Unauthorized Access</h2>
            <p style="color: #666; margin: 20px 0;">You need to be authenticated to access this profile page.</p>
            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin: 20px 0; font-size: 12px; color: #856404;">
                üí° <strong>Tip:</strong> Please login through the dashboard first, then return to this page.
            </div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="window.location.href='http://typo3.local/typo3-remote/dashboard'" style="background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                    üè† Go to Dashboard
                </button>
                <button onclick="window.location.reload()" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    `;
}

// Secure logout via remote
function secureLogout() {
    console.log('üö™ TYPO3 Profile: Initiating secure logout...');

    // Clear local state immediately
    authState = {
        isAuthenticated: false,
        user: null,
        isLoading: false
    };

    // Request logout from remote
    window.postMessage({
        type: 'LOGOUT_REQUEST',
        payload: { timestamp: Date.now() }
    }, '*');

    // Update UI immediately
    updateProfileUI();

    // Redirect to dashboard after short delay
    setTimeout(() => {
        window.location.href = 'http://typo3.local/typo3-remote/dashboard';
    }, 1000);
}

// Initialize everything
console.log('üöÄ TYPO3 Profile: Starting secure initialization...');
setupWebpackEnvironment();
initializeSecureAuth();
loadRemoteComponents();

// Mark instance as active
window.typo3ProfilePage = {
    authState,
    destroy: () => {
        console.log('üõë TYPO3 Profile: Instance destroyed');
    }
};

console.log('‚úÖ TYPO3 Profile: Secure initialization complete');
</script>
